<meta charset=utf-8>

<style>
* { margin: 0; padding: 0; border: 0; box-sizing: border-box; outline: 0; }
body { background: radial-gradient(#def 50%, #abc) fixed; text-align: center; font-family: Arial; height: 100%; }
#elements { padding: 20px 0 0 180px; }
#elements a, #tube a { position: relative; transition: all .75s; top: 0; -moz-user-select: none; user-select: none; color: #222; text-decoration: none; cursor: move; width: 100px; height: 100px; padding: 10px 5px 0; margin: 5px; border-radius: 50%; background: #fff; border: 3px solid #d00; display: inline-block; vertical-align: top; box-shadow: 5px 5px 5px #555; }
#tube a { top: -100px }
h1 { font-size: 30px; margin: 15px 0; line-height: 10px; letter-spacing: -5px; text-indent: -5px; }
h2 { font-size: 40px; font-family: Trebuchet MS; margin: 10px 0; }
h3 { font-size: 14px; margin: 10px 0; }
p { font-size: 14px; line-height: 16px }
#tube { overflow: visible; box-shadow: 5px 5px 5px #888; position: fixed; top: 50%; display: block; float: left; margin: -150px 0 0 20px; width: 150px; height: 300px; background: none repeat-y right bottom #eef; border: 5px solid #456; border-top: 5px solid #456; background-image: linear-gradient(-20deg, transparent 5%, #456 5%, #456 25%, transparent 25%); background-size: 10px 20px; border-radius: 50% / 10px 10px 20px 20px; }
#tube:before { z-index: 2; content: ""; width: 150px; height: 100px; display: block; border: 5px solid transparent; border-bottom: 5px solid #456; border-radius: 0 0 50% 50% / 0 0 15px 15px; position: fixed; left: 15px; top: 50%; margin-top: -240px; }
#tube.x1 { padding-top: 150px; transition: all .5s }
#tube.x1 a, #tube.x2 a:last-child { top: 0; }
#tube.mixed { padding-top: 150px; }
#tube.x2 { padding-top: 40px }
#tube.x2.mix a:first-child, #tube.x2.nomix a:first-child { position: relative; top: 110px; }
#tube.x2.mix a, #elements a.mix { background: #fff; color: #fff; border-color: #fff; box-shadow: 0px 0px 20px #fff; }
#tube.x2.nomix a { background: #000; color: #000; border-color: #000; box-shadow: 0px 0px 20px #000; }
#tube.x2.poof a { opacity: 0 }
#elements a.combined { position: fixed; top: 50%; left: 40px }
#buttons { padding: 20px; background: rgba(0,0,0,0.8); position: fixed; bottom: 0; width: 100%; }
button { cursor: pointer; border: 3px solid #48c; background: #ddd; font-size: 16px; line-height: 16px; padding: 5px 10px; border-radius: 5px; }
input { border: 3px solid #48c; background: #ddd; font-size: 16px; line-height: 16px; padding: 5px 10px; border-radius: 5px; }
#elements a.end { transition: none }
aside { position: fixed; top: -100px; left: 50%; opacity: 0; margin-left: -175px; z-index: 99; margin-top: -100px; transform: scale(.1); transition: all .5s; background: #def; border: 3px solid #48c; border-radius: 20px; width: 400px; padding: 20px; }
aside.visible { top: 50%; opacity: 1; transform: scale(1.5); box-shadow: 0 0 0 9999px rgba(0,0,0,0.3) }
.hidden { display: none!important; opacity: 0; transform:scale(2) } </style>

<aside id=dialog_browser>
<b>Welcome to AlcheMixer!</b>
<br>
Sorry, you must use Firefox or IE to play this game in good conditions!
<br>
<br>
<button onclick=dialog_browser.className=''>OK!</button>
</aside>

<aside id=dialog_start>
<b>Welcome to AlcheMixer!</b>
<br>
Drag & drop two elements in the test tube to create a new one!
<br>
<button onclick=dialog_start.className=''>OK!</button>
</aside>

<aside id=dialog_save>
<b>You found a new element!</b>
<br>
The first of a long list.
<br>
To help you in your quest, you'll find a search engine and a save / load button on the bottom.
<br>
<button onclick="dialog_save.className=''; buttons.className = ''; search.className = ''; ">OK!</button>
</aside>

<aside id=dialog_hint>
<b>Congrats! You found 10 elements!</b>
<br>
You now have access to a "Hint" button!
<br>
<br>
<button onclick=dialog_hint.className='';hint.style.display="">OK!</button>
</aside>

<aside id=dialog_human>
<b>Whoa! You found 30 elements!</b>
<br>
Let's add the fifth element: the Human!
<br>
<br>
<button onclick=dialog_human.className='';Human.className=''>OK!</button>
</aside>

<aside id=dialog_end>
<b>Impressive! You found 150 elements!</b>
<br>
I didn't have the time to put more in the game for JS13Kgames 2014, but you can continue the mix on <a href=" http://xem/github.io/alchemixer">http://xem/github.io/alchemixer</a>! Thanks for playing!<br>
<br>
<button onclick=dialog_end.className=''>OK!</button>
</aside>

<div id=tube>

</div>

<div id=elements>
<h2>AlcheMixer</h2>
<h3><span id=score>0</span> / 150 elements found</h3>
<a ondragstart="event.dataTransfer.effectAllowed='copy';event.dataTransfer.setData('Text',this.id)" href="javascript:;" draggable="true" class=hidden id="Human"><h1>üë´</h1><p>Human</p></a><a id=Earth draggable=true href=javascript:; ondragstart="event.dataTransfer.effectAllowed='copy';event.dataTransfer.setData('Text',this.id)"><h1>‚ôÅ</h1><p>Earth</p></a><a id=Water draggable=true href=javascript:; ondragstart="event.dataTransfer.effectAllowed='copy';event.dataTransfer.setData('Text',this.id)"><h1>üí¶</h1><p>Water</p></a><a id=Air draggable=true href=javascript:; ondragstart="event.dataTransfer.effectAllowed='copy';event.dataTransfer.setData('Text',this.id)"><h1>‚âà</h1><p>Air</p></a><a id=Fire draggable=true href=javascript:; ondragstart="event.dataTransfer.effectAllowed='copy';event.dataTransfer.setData('Text',this.id)"><h1>üî•</h1><p>Fire</p></a>
</div>

<br>
<br>
<br>

<div id=buttons class=hidden>
<input id=search placeholder=search class=hidden>
<button id=hint class=hidden onclick="this.innerHTML = show_hint()">Hint!</button>
<button id=save class=hidden onclick="localStorage['alchemixer'] = elements.innerHTML; className = 'hidden'">Save</button>
<button id=load class=hidden onclick="elements.innerHTML = localStorage['alchemixer']; className = 'hidden'; search.className = ''; if(+score.innerHTML >= 10) hint.className = ''; if(+score.innerHTML >= 30) Human.className = 'visible'; search.focus();">Load</button>
<button onclick="window.open('http://twitter.com/home?status=' + encodeURIComponent('I found ' + score.innerHTML + ' elements in #AlcheMixer!\nGive it a try on js13kgames.com.\n#js13k .@MaximeEuziere\n' + window.location))">üê§</button>
</div>
<br>
<br>
<br>
<script>

// Load
onload=function(){

  // Dialog intro
  if(navigator.userAgent.indexOf("Chrome") > -1 || navigator.userAgent.indexOf("Opera") > -1 || navigator.userAgent.indexOf("Chrome") > -1){
    setTimeout("dialog_browser.className = 'visible'", 1000);
  }
  else{
    if(!localStorage["alchemixer_start"]){
      setTimeout("dialog_start.className = 'visible'", 1000);
      localStorage["alchemixer_start"] = 1;
    }
  }

  // Save/load
  if(localStorage["alchemixer"]){
    buttons.className="";
    load.className="";
  }
  
  search.focus();
}

// Search
search.value='';
search.onkeyup=function(e){
  els = document.querySelectorAll("#elements a");
  if(search.value){
    for(i=0;i<els.length;i++){
      if(els[i].id.toLowerCase().indexOf(search.value.toLowerCase().replace(/ /g,"")) == -1){
        els[i].style.display="none";
      }
      else{
        els[i].style.display="inline-block";
      }
    }
  }
  else{
    for(i=0;i<els.length;i++){
      els[i].style.display="inline-block";
    }
  }
}

// ondragover must be handled like that to make ondrop work
tube.ondragover = function(e){
  e.preventDefault();
  e.dataTransfer.dropEffect = 'copy';
  return false;
}

// ondrop
tube.ondrop = function(e){
  e.stopPropagation();
  tube.innerHTML = top[e.dataTransfer.getData('Text')].outerHTML + tube.innerHTML;
  search.value = "";
  search.onkeyup();
  
  // 1 element dropped
  if(tube.children.length == 1){
    setTimeout('tube.className = "x1"', 10);
  }
  
  // 2 elements dropped
  if(tube.children.length == 2){
  
    tube.className = "x2";
    ok = 0;
    
    // Check the mix of the two
    for(i = 0; i < mix.length; i += 4){
      if(
        ((mix[i + 1] == tube.children[0].id && mix[i + 2] == tube.children[1].id)
        ||
        (mix[i + 1] == tube.children[1].id && mix[i + 2] == tube.children[0].id))
        &&
        top[mix[i]] === undefined
      )
      {
        setTimeout('tube.className += " mix"');
        setTimeout(function(){
          tube.className = "mixed";
          tube.innerHTML = "";
          elements.innerHTML += "<a class='combined mix' id=" + mix[i] + " draggable=true href=javascript:; ondragstart=\"event.dataTransfer.effectAllowed='copy';event.dataTransfer.setData('Text',this.id)\" title='" + mix[i+1] + " + " + mix[i+2] + "'><h1>" + mix[i + 3] + "</h1><p>" + mix[i].replace(/([a-z])([A-Z])/g, "$1 $2") + "</p></a>";
          setTimeout('top[mix[i]].className="combined";', 200);
          setTimeout('top[mix[i]].className="end";', 800);
        },500);
        ok = 1;
        
        // Enable save
        save.className = '';
        
        // Disable load
        load.className = 'hidden';
        
        score.innerHTML = +score.innerHTML + 1;
        
        // Enable menu
        if(+score.innerHTML == 1){
          setTimeout("dialog_save.className = 'visible';",2000);
        }
        
        // Enable hints
        if(+score.innerHTML == 10){
          setTimeout("dialog_hint.className = 'visible'",2000);
        }
        
        // Enable human
        if(+score.innerHTML == 150){
          setTimeout("dialog_human.className = 'visible'",2000);
        }
        
        // End
        if(+score.innerHTML == 30){
          setTimeout("dialog_end.className = 'visible'",2000);
        }
        
        // Scroll on bottom
        document.body.scrollTop = 1e7;
        
        break;
      }
    }
    
    // No combination found
    if(!ok){
      setTimeout('tube.className += " nomix";', 200);
      setTimeout('tube.className += " poof";', 800);
      setTimeout('tube.className = ""; tube.innerHTML = "";', 1300);
    }
  }
  
  search.focus();
}

// Hint
show_hint = function(){
  while(1){
    rand = Math.ceil(Math.random() * mix.length) * 4;
    if(top[mix[rand + 1]] && top[mix[rand + 2]] && !top[mix[rand]]){
      return "Try to make " + mix[rand].replace(/([a-z])([A-Z])/g, "$1 $2") + "... New hint?";
    }
  }
}

// Combinations
mix =
[

// Generation 1 (combinations of primary elements)
"Dust","Earth","Air","‚ãØ", // ok
"Lava","Fire","Earth","~üî•~", // ok
"Mud","Water","Earth","~üê∑~", // ok
"Pressure","Earth","Earth","--|  |--", // ok
"Sea","Water","Water","ÍïÄ", // ok
"Rain","Water","Air","‚òî", // ok
"Steam","Water","Fire","‚òÅ", // ok
"Energy","Air","Fire","“â", // ok

// Generation 2 (combinations of elements of previous generations)
"Gunpowder","Fire","Dust","‚ãØüî´", // ok
"Stone","Water","Lava","‚ùç", "Stone","Sea","Lava","‚ùç", "Stone","Ocean","Lava","‚ùç", // ok
"Volcano","Earth","Lava","üåã", // ok
"Brick","Fire","Mud","‚ñ≠", "Brick","Air","Mud","‚ñ≠", // ok
"Wind","Air","Pressure","üçÉ", // ok
"Ocean","Sea","Sea","ÍïÄÍïÄ<br>ÍïÄ", // ok
"Flood","Rain","Rain","~‚òî~", // ok
"Cloud","Air","Steam","‚òÅ‚òÅ‚òÅ", // ok
"Earthquake","Energy","Earth","(( üò® ))", // ok
"Alcohol","Water","Energy","üç∫", // ok
"Plant","Rain","Earth","üå±", // ok

// Generation 3
"Storm","Energy","Cloud","‚òÅ‚òÅ‚òÅ<br>‚ö°", // ok
"Explosion","Fire","Gunpowder","üí•", // ok
"Eruption","Energy","Volcano","‚òÅüåã‚òÅ", "Eruption","Lava","Volcano","‚òÅüåã‚òÅ", "Eruption","Fire","Volcano","‚òÅüåã‚òÅ", // ok
"Isle","Volcano","Ocean","üå¥", // ok
"Wall","Brick","Brick","‚ñ≠‚ñ≠‚ñ≠<br><br>‚ñ≠‚ñ≠", // ok
"Hurricane","Energy","Wind","üåÄ","Hurricane","Wind","Wind","üåÄ",// ok
"Wave","Wind","Sea","üåä","Wave","Wind","Water","üåä","Wave","Wind","Ocean","üåä",// ok
"Tsunami","Earthquake","Ocean","üåäüòìüåä",// ok
"Sky","Cloud","Air","‚òÄ‚òÅ","Sky","Cloud","Sun","‚òÄ‚òÅ",// ok
"Fog","Cloud","Earth","ﬂâ‚òÅ &nbsp;êåí",// ok
"Mountain","Earthquake","Earth","‚ó≠‚ó≠",// ok
"Metal","Fire","Stone","‚öì",// ok
"Sand","Air","Stone","‚ãØ‚ñ≥‚ãØ","Sand","Sea","Stone","‚ãØ‚ñ≥‚ãØ","Sand","Ocean","Stone","‚ãØ‚ñ≥‚ãØ","Sand","Water","Stone","‚ãØ‚ñ≥‚ãØ",// ok
"Swamp","Mud","Plant","Àá &nbsp; Àá<br>ÍïÄÍïÄÍïÄ",// ok
"Algae","Water","Plant","ÍïÄüåøÍïÄ","Algae","Sea","Plant","ÍïÄüåøÍïÄ","Algae","Ocean","Plant","ÍïÄüåøÍïÄ",// ok
"Coal","Plant","Pressure","‚ö´",// ok
"Cotton","Cloud","Plant","‚öò",// ok
"Moss","Plant","Stone","‡∑¥",// ok

// Generation 4
"Horizon","Sky","Ocean","‚òÄ<br><br>ÍïÄÍïÄÍïÄ",// ok
"AtomicBomb","Energy","Explosion","üí£",// ok
"Fireworks","Sky","Explosion","üéÜ",// ok
"Archipelago","Isle","Isle","üå¥üå¥üå¥",// ok
"Sound","Wave","Air","‚ô´",// ok
"Sun","Fire","Sky","‚òÄ",// ok
"River","Water","Mountain","‚ó≠üåä‚ó≠",// ok
"Blade","Stone","Metal","‚öî",// ok
"Sandstone","Sand","Stone","‚ãØ‚ùç‚ãØ",// ok
"Boiler","Metal","Steam","‚çû",// ok
"Bullet","Gunpowder","Metal","‚â° ‚´ê",// ok
"Electricity","Energy","Metal","‚åÅüîå",// ok
"Quicksilver","Water","Metal","‚òø",// ok
"Beach","Water","Sand","üåäüå¥",// ok
"Desert","Sand","Sand","‚ãØ·ê±·ê±‚ãØ",// ok
"Cactus","Plant","Sand","üåµ",// ok
"Clay","Sand","Swamp","üçØ", "Clay","Mud","Sand","üçØ",// ok
"Life","Energy","Swamp","‚ô•",// ok
"Diamond","Coal","Pressure","‚óá",// ok
"Grass","Earth","Moss","‡∑¥","Grass","Earth","Plant","‡∑¥‡∑¥",// ok
"Fern","Moss","Swamp","üåø",// ok

// Generation 5
"Oxygen","Sun","Plant","‚öõ",// ok
"Salt","Sun","Ocean","œ¥", "Salt","Sun","Sea","œ¥",// ok
"Gun","Metal","Bullet","<div style='text-align:left;margin:-20px 0 0 20px'>,____,<br><br><br>//'<br>~</div>",// ok
"Sword","Metal","Blade","‚öî",// ok
"Pottery","Fire","Clay","üçØ",// ok
"Oasis","Water","Desert","‚ãØüå¥‚ãØ",// ok
"Pyramid","Desert","Stone","‚ãØ‚óÆ‚ãØ",// ok
"Flower","Sun","Grass","‚ùÄ", "Flower","Plant","Garden","‚ùÄ",// ok
"Scythe","Blade","Grass","„É¨",// ok
"Dew","Grass","Fog","“à",// ok
"Ring","Diamond","Metal","‚óé",// ok
"Tobacco","Fire","Plant","üö¨",// ok
"RadioWave","Electricity","Air","(( üìª ))", // ok

// Generation 6
"Glass","Electricity","Sand","üç∑", "Glass","Fire","Sand","üç∑",// ok
"Lightsaber","Energy","Sword","<span style=font-size:17px>‚ï£=========","Lightsaber","Light","Sword","<span style=font-size:17px>‚ï£=========",// ok
"Hay","Scythe","Grass","‚ùç &nbsp; üêë",// ok
"Garden","Flower","Flower","üåª üíÆ<br><br>üå∫","Garden","Flower","Grass","üåª üíÆ<br><br>üå∫","Garden","Plant","Grass","üåª üíÆ<br><br>üå∫",// ok
"Sunflower","Sun","Flower","üåª",// ok

// Generation 7
"Scissors","Blade","Blade","‚úÇ",// ok
"LightBulb","Electricity","Glass","üí°",// ok
"MagnifyingGlass","Metal","Glass","üîç",// ok
"Time","Sand","Glass","‚¥µ",// ok
"Eyeglasses","Glass","Glass","üëì",// ok
"Aquarium","Water","Glass","( &nbsp; üêü &nbsp; )<br>___",// ok
"Ice","Glass","Water","‚ùí<br><br>‚ùí‚ùí","Ice","Water","Cold","‚ùí<br><br>‚ùí‚ùí",// ok
"Needle","Hay","Metal","~ &nbsp; &nbsp; &nbsp; &nbsp; <br>‚ïø",// ok
"Oil","Sunflower","Pressure","‡ÆÉ", "Oil","Coal","Water","‡ÆÉ",// ok

// Generation 8
"Napalm","Fire","Oil","‚òÅüí•‚òÅ",// ok
"Light","Electricity","LightBulb","‚™´üí°‚™™",// ok
"Sunglasses","Sun","Glass","üòé","Sunglasses","Sun","Eyeglasses","üòé",// ok
"Lamp","LightBulb","Metal","<div style=margin-top:-35px>__<br><br><br>/___\\<br><br><br>(_)",// ok
"Hail","Cloud","Ice","<div style=margin-top:-10px>| |<br><br><br>ﬂã",// ok
"Iceberg","Sea","Ice","~‚ßç~","Iceberg","Ocean","Ice","~‚ßç~",// ok
"Clock","Electricity","Time","‚è∞",// ok
"TV","LightBulb","RadioWave","üì∫",// ok

// Generation Human + 1
"Blood","Human","Blade","üíß &nbsp; üíß",// ok
"CarbonDioxide","Human","Air","C O ¬≤",// ok
"Cold","Rain","Human","‚åá‚åá&nbsp; üòì &nbsp; ‚åá‚åá",// ok
"Corpse","Fire","Human","‚ò†","Corpse","Human","Gun","‚ò†",// ok
"Drunk","Human","Alcohol","üòµ",// ok
"Electrician","Electricity","Human","üòÅüîå",// ok
"Tools","Metal","Human","‚öí",// ok
"Fireman","Fire","Human","üî•üò∑üî•",// ok
"House","Brick","Human","üè†",// ok
"Idea","LightBulb","Human","üò§üí°",// ok
"Love","Human","Human","‚ù§",// ok
"Music","Sound","Human","‚ô¨ ‚ô™",// ok
"Surfer","Wave","Human","üåä<u>üèÉ</u>",// ok
"Watch","Human","Clock","‚åö",// ok
"Death","Human","Life","‚úù",// ok

// Generation Human + 2
"Engineer","Human","Tools","üò≤ ‚öí",// ok
"Fridge","Metal","Cold","êåá",// ok
"Snow","Rain","Cold","‚ùÑ",// ok
"Grave","Earth","Corpse","‚Ä†<br>‡∑¥",// ok
"Bone","Time","Corpse","üçñ",// ok
"Umbrella","Rain","Tools","‚òÇ",// ok
"Field","Earth","Tools","‡∑¥‡∑¥<br><br>‡∑¥‡∑¥",// ok
"Pitchfork","Tools","Hay","&nbsp; |<br>‚ãî",// ok
"Statue","Stone","Tools","üóΩ",// ok
"Family","Human","House","üè†üë´",// ok
"Village","House","House","üè† üè†<br><br>üè† üè† üè†",// ok
"Ash","Fire","House","‚ñ≤","Ash","Fire","Human","‚ñ≤","Ash","Fire","Wood","‚ñ≤",// ok
"Rose","Love","Plant","üåπ",// ok

// Generation Human + 3
"Snowman","Snow","Human","‚òÉ",// ok
"Gravestone","Stone","Grave","‚úù",// ok
"Graveyard","Grave","Grave","‚úù ‚úù ‚úù",// ok
"Farmer","Human","Field","üòãüêÆ",// ok
"Fountain","Statue","Water","‚õ≤",// ok

// Generation Human + 4
"Farm","Farmer","House","‡∑¥üè†‡∑¥",// ok
"Livestock","Life","Farmer","üêî üê∑",// ok
"Wire","Electricity","Metal","‡≤ä",// ok

// Generation Human + 5
"Dynamite","Wire","Gunpowder","<div style=margin-top:-30px>&nbsp;Àå<br><br><br>‚å∑",// ok
"Horse","Hay","Livestock","üêé",// ok
"Pig","Mud","Livestock","üê∑",// ok
"Sheep","Cloud","Livestock","üêë",// ok
"Cow","Livestock","Grass","üêÆ",// ok

// Generation Human + 6
"Bacon","Fire","Pig","‚ô®",// ok
"Meat","Tools","Cow","üçñ",// ok
"Milk","Farmer","Cow","üçµ",// ok

// Generation Human + 7
"Sweater","Sheep","Tools","üëï",// ok
"Butter","Milk","Pressure","Ô¨¶",// ok
"Cheese","Time","Milk","üç†",// ok
"IceCream","Cold","Milk","üç¶","IceCream","Ice","Milk","üç¶",// ok

// Generation Human + 8
"Moon","Sky","Cheese","‚òæ",// ok
"MilkShake","Milk","IceCream","üç∫",// ok

// Generation Human + 9
"Night","Time","Moon","‚òæ ‚òÜ",// ok
"Eclipse","Sun","Moon","üåî",// ok

// Generation Human + 10
"Star","Night","Sky","‚òÜ",// ok
"Ghost","Graveyard","Night","üëª",// ok

// Generation Human + 11
"Constellation","Star","Star","<div style=margin-top:-10px>‚òÜ<br><br>‚òÜ &nbsp; ‚òÜ",// ok
"Shuriken","Star","Blade","‚úß",// ok
"Space","Star","Sky","&nbsp;",// ok

// Generation Human + 12
"Ninja","Human","Shuriken","üôÖ",// ok
"Void","Space","Space","&nbsp;&nbsp;",// ok
"Meteoroid","Stone","Space","üå†",// ok

// Generation Human + 13
"Alien","Life","Void","üëΩ","Alien","Space","Life","üëΩ",// ok
"LightBulb","Void","Glass","üí°",// ok, dup
"RadioWave","Void","Electricity","(( üìª ))",// ok, dup

];

// Music
jsonSong = {
    "songLen": 123,
    "songData": [
        {
            "osc1_oct": 9,
            "osc1_det": 0,
            "osc1_detune": 0,
            "osc1_xenv": 0,
            "osc1_vol": 161,
            "osc1_waveform": 0,
            "osc2_oct": 9,
            "osc2_det": 0,
            "osc2_detune": 4,
            "osc2_xenv": 0,
            "osc2_vol": 182,
            "osc2_waveform": 0,
            "noise_fader": 0,
            "env_attack": 100,
            "env_sustain": 1818,
            "env_release": 18181,
            "env_master": 192,
            "fx_filter": 0,
            "fx_freq": 0,
            "fx_resonance": 254,
            "fx_delay_time": 6,
            "fx_delay_amt": 108,
            "fx_pan_freq": 3,
            "fx_pan_amt": 61,
            "lfo_osc1_freq": 0,
            "lfo_fx_freq": 0,
            "lfo_freq": 3,
            "lfo_amt": 94,
            "lfo_waveform": 2,
            "p": [
                1,
                2,
                1,
                2,
                1,
                2,
                1,
                2,
                1,
                2,
                1,
                2,
                1,
                2,
                1,
                2,
                0,
                2,
                3,
                4,
                1,
                2,
                3,
                4,
                5,
                6,
                7,
                8,
                5
            ],
            "c": [
                {
                    "n": [
                        142,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        140,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        138,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0
                    ]
                },
                {
                    "n": [
                        135,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        135,
                        0,
                        0,
                        0,
                        138,
                        0,
                        0,
                        0
                    ]
                },
                {
                    "n": [
                        140,
                        0,
                        138,
                        0,
                        135,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        130,
                        0,
                        142,
                        0,
                        140,
                        0,
                        135,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        138,
                        0,
                        0,
                        0
                    ]
                },
                {
                    "n": [
                        135,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        130,
                        0,
                        142,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        135,
                        0,
                        0,
                        0,
                        138,
                        0,
                        0,
                        0
                    ]
                },
                {
                    "n": [
                        123,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0
                    ]
                },
                {
                    "n": [
                        130,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0
                    ]
                },
                {
                    "n": [
                        128,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0
                    ]
                },
                {
                    "n": [
                        119,
                        131,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        126,
                        114,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0
                    ]
                }
            ]
        },
        {
            "osc1_oct": 8,
            "osc1_det": 0,
            "osc1_detune": 0,
            "osc1_xenv": 0,
            "osc1_vol": 0,
            "osc1_waveform": 0,
            "osc2_oct": 8,
            "osc2_det": 0,
            "osc2_detune": 0,
            "osc2_xenv": 0,
            "osc2_vol": 0,
            "osc2_waveform": 0,
            "noise_fader": 19,
            "env_attack": 100,
            "env_sustain": 0,
            "env_release": 3636,
            "env_master": 192,
            "fx_filter": 1,
            "fx_freq": 8100,
            "fx_resonance": 156,
            "fx_delay_time": 2,
            "fx_delay_amt": 22,
            "fx_pan_freq": 3,
            "fx_pan_amt": 43,
            "lfo_osc1_freq": 0,
            "lfo_fx_freq": 0,
            "lfo_freq": 0,
            "lfo_amt": 0,
            "lfo_waveform": 0,
            "p": [
                0,
                0,
                1,
                2,
                1,
                2,
                1,
                2,
                1,
                2,
                1,
                2,
                1,
                2,
                1,
                2,
                1,
                2,
                1,
                2,
                1,
                2,
                1,
                2,
                1,
                2,
                1,
                2
            ],
            "c": [
                {
                    "n": [
                        135,
                        0,
                        135,
                        0,
                        0,
                        135,
                        0,
                        135,
                        135,
                        0,
                        135,
                        0,
                        0,
                        135,
                        0,
                        135,
                        135,
                        0,
                        135,
                        0,
                        0,
                        135,
                        0,
                        135,
                        135,
                        0,
                        135,
                        0,
                        0,
                        135,
                        0,
                        135
                    ]
                },
                {
                    "n": [
                        135,
                        0,
                        135,
                        0,
                        0,
                        135,
                        0,
                        135,
                        135,
                        0,
                        135,
                        0,
                        0,
                        135,
                        0,
                        135,
                        135,
                        0,
                        135,
                        0,
                        0,
                        135,
                        0,
                        135,
                        135,
                        0,
                        135,
                        0,
                        135,
                        0,
                        135,
                        135
                    ]
                }
            ]
        },
        {
            "osc1_oct": 6,
            "osc1_det": 0,
            "osc1_detune": 0,
            "osc1_xenv": 0,
            "osc1_vol": 192,
            "osc1_waveform": 1,
            "osc2_oct": 8,
            "osc2_det": 0,
            "osc2_detune": 8,
            "osc2_xenv": 0,
            "osc2_vol": 82,
            "osc2_waveform": 2,
            "noise_fader": 0,
            "env_attack": 100,
            "env_sustain": 4545,
            "env_release": 2727,
            "env_master": 192,
            "fx_filter": 3,
            "fx_freq": 2700,
            "fx_resonance": 85,
            "fx_delay_time": 6,
            "fx_delay_amt": 60,
            "fx_pan_freq": 6,
            "fx_pan_amt": 86,
            "lfo_osc1_freq": 0,
            "lfo_fx_freq": 1,
            "lfo_freq": 7,
            "lfo_amt": 106,
            "lfo_waveform": 0,
            "p": [
                0,
                0,
                0,
                0,
                1,
                1,
                2,
                3,
                1,
                1,
                2,
                3,
                1,
                1,
                2,
                3,
                1,
                1,
                2,
                3,
                1,
                1,
                2,
                3
            ],
            "c": [
                {
                    "n": [
                        135,
                        135,
                        147,
                        135,
                        0,
                        135,
                        147,
                        135,
                        135,
                        135,
                        147,
                        135,
                        0,
                        135,
                        147,
                        135,
                        135,
                        135,
                        147,
                        135,
                        0,
                        135,
                        147,
                        135,
                        135,
                        135,
                        147,
                        135,
                        0,
                        135,
                        147,
                        135
                    ]
                },
                {
                    "n": [
                        140,
                        140,
                        152,
                        140,
                        0,
                        140,
                        152,
                        140,
                        140,
                        140,
                        152,
                        140,
                        0,
                        140,
                        152,
                        140,
                        140,
                        140,
                        152,
                        140,
                        0,
                        140,
                        152,
                        140,
                        140,
                        140,
                        152,
                        140,
                        0,
                        140,
                        152,
                        142
                    ]
                },
                {
                    "n": [
                        131,
                        131,
                        143,
                        131,
                        0,
                        131,
                        143,
                        131,
                        131,
                        131,
                        143,
                        131,
                        0,
                        131,
                        143,
                        131,
                        138,
                        138,
                        150,
                        138,
                        0,
                        138,
                        150,
                        138,
                        138,
                        138,
                        150,
                        138,
                        0,
                        138,
                        150,
                        137
                    ]
                }
            ]
        },
        {
            "osc1_oct": 7,
            "osc1_det": 0,
            "osc1_detune": 0,
            "osc1_xenv": 0,
            "osc1_vol": 187,
            "osc1_waveform": 2,
            "osc2_oct": 5,
            "osc2_det": 0,
            "osc2_detune": 2,
            "osc2_xenv": 1,
            "osc2_vol": 161,
            "osc2_waveform": 2,
            "noise_fader": 0,
            "env_attack": 100,
            "env_sustain": 1818,
            "env_release": 2727,
            "env_master": 123,
            "fx_filter": 1,
            "fx_freq": 1900,
            "fx_resonance": 162,
            "fx_delay_time": 2,
            "fx_delay_amt": 153,
            "fx_pan_freq": 6,
            "fx_pan_amt": 61,
            "lfo_osc1_freq": 0,
            "lfo_fx_freq": 1,
            "lfo_freq": 2,
            "lfo_amt": 196,
            "lfo_waveform": 3,
            "p": [
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                1,
                1,
                1,
                2,
                1,
                1,
                1,
                2,
                1,
                1,
                1,
                2,
                1,
                1,
                1,
                2,
                1,
                1,
                1,
                2,
                3
            ],
            "c": [
                {
                    "n": [
                        135,
                        135,
                        138,
                        135,
                        142,
                        135,
                        140,
                        138,
                        135,
                        135,
                        138,
                        135,
                        142,
                        135,
                        140,
                        138,
                        135,
                        135,
                        138,
                        135,
                        142,
                        135,
                        140,
                        138,
                        135,
                        135,
                        138,
                        135,
                        142,
                        135,
                        140,
                        138
                    ]
                },
                {
                    "n": [
                        143,
                        143,
                        155,
                        143,
                        0,
                        143,
                        155,
                        143,
                        143,
                        143,
                        150,
                        143,
                        147,
                        143,
                        140,
                        143,
                        138,
                        138,
                        143,
                        138,
                        143,
                        140,
                        138,
                        140,
                        138,
                        138,
                        143,
                        138,
                        142,
                        140,
                        138,
                        140
                    ]
                },
                {
                    "n": [
                        135,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0
                    ]
                }
            ]
        },
        {
            "osc1_oct": 8,
            "osc1_det": 0,
            "osc1_detune": 0,
            "osc1_xenv": 1,
            "osc1_vol": 192,
            "osc1_waveform": 0,
            "osc2_oct": 7,
            "osc2_det": 0,
            "osc2_detune": 0,
            "osc2_xenv": 1,
            "osc2_vol": 70,
            "osc2_waveform": 2,
            "noise_fader": 8,
            "env_attack": 100,
            "env_sustain": 0,
            "env_release": 9090,
            "env_master": 164,
            "fx_filter": 2,
            "fx_freq": 5500,
            "fx_resonance": 240,
            "fx_delay_time": 6,
            "fx_delay_amt": 51,
            "fx_pan_freq": 3,
            "fx_pan_amt": 66,
            "lfo_osc1_freq": 0,
            "lfo_fx_freq": 0,
            "lfo_freq": 0,
            "lfo_amt": 0,
            "lfo_waveform": 0,
            "p": [
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                1,
                1,
                1,
                1,
                1,
                1,
                1,
                1,
                1,
                1,
                1,
                1
            ],
            "c": [
                {
                    "n": [
                        135,
                        0,
                        0,
                        0,
                        0,
                        0,
                        135,
                        0,
                        0,
                        0,
                        135,
                        0,
                        0,
                        0,
                        0,
                        0,
                        135,
                        0,
                        0,
                        0,
                        0,
                        0,
                        135,
                        0,
                        0,
                        0,
                        135,
                        0,
                        0,
                        0,
                        0,
                        0
                    ]
                }
            ]
        },
        {
            "osc1_oct": 7,
            "osc1_det": 0,
            "osc1_detune": 0,
            "osc1_xenv": 0,
            "osc1_vol": 192,
            "osc1_waveform": 2,
            "osc2_oct": 8,
            "osc2_det": 0,
            "osc2_detune": 6,
            "osc2_xenv": 0,
            "osc2_vol": 184,
            "osc2_waveform": 2,
            "noise_fader": 21,
            "env_attack": 40000,
            "env_sustain": 25454,
            "env_release": 90909,
            "env_master": 77,
            "fx_filter": 2,
            "fx_freq": 7100,
            "fx_resonance": 188,
            "fx_delay_time": 8,
            "fx_delay_amt": 147,
            "fx_pan_freq": 4,
            "fx_pan_amt": 69,
            "lfo_osc1_freq": 0,
            "lfo_fx_freq": 1,
            "lfo_freq": 7,
            "lfo_amt": 176,
            "lfo_waveform": 1,
            "p": [
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                1,
                2,
                3,
                4,
                1,
                2,
                3,
                4,
                1,
                2,
                3,
                4,
                1,
                2,
                3,
                4,
                5
            ],
            "c": [
                {
                    "n": [
                        135,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0
                    ]
                },
                {
                    "n": [
                        142,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0
                    ]
                },
                {
                    "n": [
                        128,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0
                    ]
                },
                {
                    "n": [
                        143,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        138,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0
                    ]
                },
                {
                    "n": [
                        135,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0
                    ]
                }
            ]
        },
        {
            "osc1_oct": 8,
            "osc1_det": 0,
            "osc1_detune": 0,
            "osc1_xenv": 0,
            "osc1_vol": 0,
            "osc1_waveform": 0,
            "osc2_oct": 8,
            "osc2_det": 0,
            "osc2_detune": 0,
            "osc2_xenv": 0,
            "osc2_vol": 0,
            "osc2_waveform": 0,
            "noise_fader": 148,
            "env_attack": 3636,
            "env_sustain": 4545,
            "env_release": 39090,
            "env_master": 136,
            "fx_filter": 2,
            "fx_freq": 3100,
            "fx_resonance": 122,
            "fx_delay_time": 5,
            "fx_delay_amt": 132,
            "fx_pan_freq": 0,
            "fx_pan_amt": 0,
            "lfo_osc1_freq": 0,
            "lfo_fx_freq": 1,
            "lfo_freq": 5,
            "lfo_amt": 147,
            "lfo_waveform": 0,
            "p": [
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                1,
                2,
                1,
                3,
                1,
                2,
                1,
                3,
                4
            ],
            "c": [
                {
                    "n": [
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        135,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        135,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0
                    ]
                },
                {
                    "n": [
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        135,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        162,
                        0,
                        135,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0
                    ]
                },
                {
                    "n": [
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        135,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        151,
                        0,
                        0,
                        0,
                        0,
                        0,
                        135,
                        0,
                        135,
                        0,
                        0,
                        0,
                        0,
                        0
                    ]
                },
                {
                    "n": [
                        135,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0
                    ]
                }
            ]
        }
    ],
    "rowLen": 5606,
    "endPattern": 30
};

//
// Sonant-X
//
// Copyright (c) 2014 Nicolas Vanhoren
//
// Sonant-X is a fork of js-sonant by Marcus Geelnard and Jake Taylor. It is
// still published using the same license (zlib license, see below).
//
// Copyright (c) 2011 Marcus Geelnard
// Copyright (c) 2008-2009 Jake Taylor
//
// This software is provided 'as-is', without any express or implied
// warranty. In no event will the authors be held liable for any damages
// arising from the use of this software.
//
// Permission is granted to anyone to use this software for any purpose,
// including commercial applications, and to alter it and redistribute it
// freely, subject to the following restrictions:
//
// 1. The origin of this software must not be misrepresented; you must not
//    claim that you wrote the original software. If you use this software
//    in a product, an acknowledgment in the product documentation would be
//    appreciated but is not required.
//
// 2. Altered source versions must be plainly marked as such, and must not be
//    misrepresented as being the original software.
//
// 3. This notice may not be removed or altered from any source
//    distribution.

var sonantx;
(function() {
"use strict";
sonantx = {};

var WAVE_SPS = 44100;                    // Samples per second
var WAVE_CHAN = 2;                       // Channels
var MAX_TIME = 33; // maximum time, in millis, that the generator can use consecutively

var audioCtx = null;

// Oscillators
function osc_sin(value)
{
    return Math.sin(value * 6.283184);
}

function osc_square(value)
{
    if(osc_sin(value) < 0) return -1;
    return 1;
}

function osc_saw(value)
{
    return (value % 1) - 0.5;
}

function osc_tri(value)
{
    var v2 = (value % 1) * 4;
    if(v2 < 2) return v2 - 1;
    return 3 - v2;
}

// Array of oscillator functions
var oscillators =
[
    osc_sin,
    osc_square,
    osc_saw,
    osc_tri
];

function getnotefreq(n)
{
    return 0.00390625 * Math.pow(1.059463094, n - 128);
}

function genBuffer(waveSize, callBack) {
    setTimeout(function() {
        // Create the channel work buffer
        var buf = new Uint8Array(waveSize * WAVE_CHAN * 2);
        var b = buf.length - 2;
        var iterate = function() {
            var begin = new Date();
            var count = 0;
            while(b >= 0)
            {
                buf[b] = 0;
                buf[b + 1] = 128;
                b -= 2;
                count += 1;
                if (count % 1000 === 0 && (new Date() - begin) > MAX_TIME) {
                    setTimeout(iterate, 0);
                    return;
                }
            }
            setTimeout(function() {callBack(buf);}, 0);
        };
        setTimeout(iterate, 0);
    }, 0);
}

function applyDelay(chnBuf, waveSamples, instr, rowLen, callBack) {
    var p1 = (instr.fx_delay_time * rowLen) >> 1;
    var t1 = instr.fx_delay_amt / 255;

    var n1 = 0;
    var iterate = function() {
        var beginning = new Date();
        var count = 0;
        while(n1 < waveSamples - p1)
        {
            var b1 = 4 * n1;
            var l = 4 * (n1 + p1);

            // Left channel = left + right[-p1] * t1
            var x1 = chnBuf[l] + (chnBuf[l+1] << 8) +
                (chnBuf[b1+2] + (chnBuf[b1+3] << 8) - 32768) * t1;
            chnBuf[l] = x1 & 255;
            chnBuf[l+1] = (x1 >> 8) & 255;

            // Right channel = right + left[-p1] * t1
            x1 = chnBuf[l+2] + (chnBuf[l+3] << 8) +
                (chnBuf[b1] + (chnBuf[b1+1] << 8) - 32768) * t1;
            chnBuf[l+2] = x1 & 255;
            chnBuf[l+3] = (x1 >> 8) & 255;
            ++n1;
            count += 1;
            if (count % 1000 === 0 && (new Date() - beginning) > MAX_TIME) {
                setTimeout(iterate, 0);
                return;
            }
        }
        setTimeout(callBack, 0);
    };
    setTimeout(iterate, 0);
}

sonantx.AudioGenerator = function(mixBuf) {
    this.mixBuf = mixBuf;
    this.waveSize = mixBuf.length / WAVE_CHAN / 2;
};
sonantx.AudioGenerator.prototype.getWave = function() {
    var mixBuf = this.mixBuf;
    var waveSize = this.waveSize;
    // Local variables
    var b, k, x, wave, l1, l2, s, y;

    // Turn critical object properties into local variables (performance)
    var waveBytes = waveSize * WAVE_CHAN * 2;

    // Convert to a WAVE file (in a binary string)
    l1 = waveBytes - 8;
    l2 = l1 - 36;
    wave = String.fromCharCode(82,73,70,70,
                               l1 & 255,(l1 >> 8) & 255,(l1 >> 16) & 255,(l1 >> 24) & 255,
                               87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,
                               68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,
                               l2 & 255,(l2 >> 8) & 255,(l2 >> 16) & 255,(l2 >> 24) & 255);
    b = 0;
    while(b < waveBytes)
    {
        // This is a GC & speed trick: don't add one char at a time - batch up
        // larger partial strings
        x = "";
        for (k = 0; k < 256 && b < waveBytes; ++k, b += 2)
        {
            // Note: We amplify and clamp here
            y = 4 * (mixBuf[b] + (mixBuf[b+1] << 8) - 32768);
            y = y < -32768 ? -32768 : (y > 32767 ? 32767 : y);
            x += String.fromCharCode(y & 255, (y >> 8) & 255);
        }
        wave += x;
    }
    return wave;
};
sonantx.AudioGenerator.prototype.getAudio = function() {
    var wave = this.getWave();
    var a = new Audio("data:audio/wav;base64," + btoa(wave));
    a.preload = "none";
    a.load();
    return a;
};
sonantx.AudioGenerator.prototype.getAudioBuffer = function(callBack) {
    if (audioCtx === null)
        audioCtx = new AudioContext();
    var mixBuf = this.mixBuf;
    var waveSize = this.waveSize;

    var waveBytes = waveSize * WAVE_CHAN * 2;
    var buffer = audioCtx.createBuffer(WAVE_CHAN, this.waveSize, WAVE_SPS); // Create Mono Source Buffer from Raw Binary
    var lchan = buffer.getChannelData(0);
    var rchan = buffer.getChannelData(1);
    var b = 0;
    var iterate = function() {
        var beginning = new Date();
        var count = 0;
        while (b < (waveBytes / 2)) {
            var y = 4 * (mixBuf[b * 4] + (mixBuf[(b * 4) + 1] << 8) - 32768);
            y = y < -32768 ? -32768 : (y > 32767 ? 32767 : y);
            lchan[b] = y / 32768;
            y = 4 * (mixBuf[(b * 4) + 2] + (mixBuf[(b * 4) + 3] << 8) - 32768);
            y = y < -32768 ? -32768 : (y > 32767 ? 32767 : y);
            rchan[b] = y / 32768;
            b += 1;
            count += 1;
            if (count % 1000 === 0 && new Date() - beginning > MAX_TIME) {
                setTimeout(iterate, 0);
                return;
            }
        }
        setTimeout(function() {callBack(buffer);}, 0);
    };
    setTimeout(iterate, 0);
};

sonantx.SoundGenerator = function(instr, rowLen) {
    this.instr = instr;
    this.rowLen = rowLen || 5605;

    this.osc_lfo = oscillators[instr.lfo_waveform];
    this.osc1 = oscillators[instr.osc1_waveform];
    this.osc2 = oscillators[instr.osc2_waveform];
    this.attack = instr.env_attack;
    this.sustain = instr.env_sustain;
    this.release = instr.env_release;
    this.panFreq = Math.pow(2, instr.fx_pan_freq - 8) / this.rowLen;
    this.lfoFreq = Math.pow(2, instr.lfo_freq - 8) / this.rowLen;
};
sonantx.SoundGenerator.prototype.genSound = function(n, chnBuf, currentpos) {
    var marker = new Date();
    var c1 = 0;
    var c2 = 0;

    // Precalculate frequencues
    var o1t = getnotefreq(n + (this.instr.osc1_oct - 8) * 12 + this.instr.osc1_det) * (1 + 0.0008 * this.instr.osc1_detune);
    var o2t = getnotefreq(n + (this.instr.osc2_oct - 8) * 12 + this.instr.osc2_det) * (1 + 0.0008 * this.instr.osc2_detune);

    // State variable init
    var q = this.instr.fx_resonance / 255;
    var low = 0;
    var band = 0;
    for (var j = this.attack + this.sustain + this.release - 1; j >= 0; --j)
    {
        var k = j + currentpos;

        // LFO
        var lfor = this.osc_lfo(k * this.lfoFreq) * this.instr.lfo_amt / 512 + 0.5;

        // Envelope
        var e = 1;
        if(j < this.attack)
            e = j / this.attack;
        else if(j >= this.attack + this.sustain)
            e -= (j - this.attack - this.sustain) / this.release;

        // Oscillator 1
        var t = o1t;
        if(this.instr.lfo_osc1_freq) t += lfor;
        if(this.instr.osc1_xenv) t *= e * e;
        c1 += t;
        var rsample = this.osc1(c1) * this.instr.osc1_vol;

        // Oscillator 2
        t = o2t;
        if(this.instr.osc2_xenv) t *= e * e;
        c2 += t;
        rsample += this.osc2(c2) * this.instr.osc2_vol;

        // Noise oscillator
        if(this.instr.noise_fader) rsample += (2*Math.random()-1) * this.instr.noise_fader * e;

        rsample *= e / 255;

        // State variable filter
        var f = this.instr.fx_freq;
        if(this.instr.lfo_fx_freq) f *= lfor;
        f = 1.5 * Math.sin(f * 3.141592 / WAVE_SPS);
        low += f * band;
        var high = q * (rsample - band) - low;
        band += f * high;
        switch(this.instr.fx_filter)
        {
            case 1: // Hipass
                rsample = high;
                break;
            case 2: // Lopass
                rsample = low;
                break;
            case 3: // Bandpass
                rsample = band;
                break;
            case 4: // Notch
                rsample = low + high;
                break;
            default:
        }

        // Panning & master volume
        t = osc_sin(k * this.panFreq) * this.instr.fx_pan_amt / 512 + 0.5;
        rsample *= 39 * this.instr.env_master;

        // Add to 16-bit channel buffer
        k = k * 4;
        if (k + 3 < chnBuf.length) {
            var x = chnBuf[k] + (chnBuf[k+1] << 8) + rsample * (1 - t);
            chnBuf[k] = x & 255;
            chnBuf[k+1] = (x >> 8) & 255;
            x = chnBuf[k+2] + (chnBuf[k+3] << 8) + rsample * t;
            chnBuf[k+2] = x & 255;
            chnBuf[k+3] = (x >> 8) & 255;
        }
    }
};
sonantx.SoundGenerator.prototype.getAudioGenerator = function(n, callBack) {
    var bufferSize = (this.attack + this.sustain + this.release - 1) + (32 * this.rowLen);
    var self = this;
    genBuffer(bufferSize, function(buffer) {
        self.genSound(n, buffer, 0);
        applyDelay(buffer, bufferSize, self.instr, self.rowLen, function() {
            callBack(new sonantx.AudioGenerator(buffer));
        });
    });
};
sonantx.SoundGenerator.prototype.createAudio = function(n, callBack) {
    this.getAudioGenerator(n, function(ag) {
        callBack(ag.getAudio());
    });
};
sonantx.SoundGenerator.prototype.createAudioBuffer = function(n, callBack) {
    this.getAudioGenerator(n, function(ag) {
        ag.getAudioBuffer(callBack);
    });
};

sonantx.MusicGenerator = function(song) {
    this.song = song;
    // Wave data configuration
    this.waveSize = WAVE_SPS * song.songLen; // Total song size (in samples)
};
sonantx.MusicGenerator.prototype.generateTrack = function (instr, mixBuf, callBack) {
    var self = this;
    genBuffer(this.waveSize, function(chnBuf) {
        // Preload/precalc some properties/expressions (for improved performance)
        var waveSamples = self.waveSize,
            waveBytes = self.waveSize * WAVE_CHAN * 2,
            rowLen = self.song.rowLen,
            endPattern = self.song.endPattern,
            soundGen = new sonantx.SoundGenerator(instr, rowLen);

        var currentpos = 0;
        var p = 0;
        var row = 0;
        var recordSounds = function() {
            var beginning = new Date();
            while (true) {
                if (row === 32) {
                    row = 0;
                    p += 1;
                    continue;
                }
                if (p === endPattern - 1) {
                    setTimeout(delay, 0);
                    return;
                }
                var cp = instr.p[p];
                if (cp) {
                    var n = instr.c[cp - 1].n[row];
                    if (n) {
                        soundGen.genSound(n, chnBuf, currentpos);
                    }
                }
                currentpos += rowLen;
                row += 1;
                if (new Date() - beginning > MAX_TIME) {
                    setTimeout(recordSounds, 0);
                    return;
                }
            }
        };

        var delay = function() {
            applyDelay(chnBuf, waveSamples, instr, rowLen, finalize);
        };

        var b2 = 0;
        var finalize = function() {
            var beginning = new Date();
            var count = 0;
            // Add to mix buffer
            while(b2 < waveBytes)
            {
                var x2 = mixBuf[b2] + (mixBuf[b2+1] << 8) + chnBuf[b2] + (chnBuf[b2+1] << 8) - 32768;
                mixBuf[b2] = x2 & 255;
                mixBuf[b2+1] = (x2 >> 8) & 255;
                b2 += 2;
                count += 1;
                if (count % 1000 === 0 && (new Date() - beginning) > MAX_TIME) {
                    setTimeout(finalize, 0);
                    return;
                }
            }
            setTimeout(callBack, 0);
        };
        setTimeout(recordSounds, 0);
    });
};
sonantx.MusicGenerator.prototype.getAudioGenerator = function(callBack) {
    var self = this;
    genBuffer(this.waveSize, function(mixBuf) {
        var t = 0;
        var recu = function() {
            if (t < self.song.songData.length) {
                t += 1;
                self.generateTrack(self.song.songData[t - 1], mixBuf, recu);
            } else {
                callBack(new sonantx.AudioGenerator(mixBuf));
            }
        };
        recu();
    });
};
sonantx.MusicGenerator.prototype.createAudio = function(callBack) {
    this.getAudioGenerator(function(ag) {
        callBack(ag.getAudio());
    });
};
sonantx.MusicGenerator.prototype.createAudioBuffer = function(callBack) {
    this.getAudioGenerator(function(ag) {
        ag.getAudioBuffer(callBack);
    });
};

})();


var songGen = new sonantx.MusicGenerator(jsonSong);

songGen.createAudio(function(audio) {
  audio.play();
})
    
setInterval(
  function(){
    songGen.createAudio(function(audio) {
      audio.play();
    });
  },
  60000
)

</script>